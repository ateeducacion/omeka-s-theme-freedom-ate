name: Release
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build_and_upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set environment variables
        run: |
          # Extract version from tag (removes 'v' prefix)
          TAG_NAME=${GITHUB_REF##*/}
          VERSION=${TAG_NAME#v}
          echo "RELEASE_TAG=${TAG_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Update theme.ini version
        run: |
          echo "Updating version to ${{ env.VERSION }} in config/theme.ini..."
          sed -i 's/^\([[:space:]]*version[[:space:]]*=[[:space:]]*\).*$/\1"${{ env.VERSION }}"/' config/theme.ini
          echo "Updated version in theme.ini:"
          grep -E '^[[:space:]]*version' config/theme.ini

      - name: Generate Release Notes
        id: notes
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            NOTES=$(git log --pretty=format:"- %s (%h)" HEAD | head -20)
          else
            NOTES=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create package using the Makefile
        run: make package VERSION=${{ env.VERSION }}

      - name: Create Release and Upload ZIP
        uses: softprops/action-gh-release@v2
        with:
          files: freedom-ate-${{ env.VERSION }}.zip
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          body: |
            ## ðŸ“¦ Changes in ${{ env.RELEASE_TAG }}

            ${{ steps.notes.outputs.notes }}

            ## ðŸ“¥ Installation
            Download the ZIP file and extract it to your Omeka S themes directory.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
